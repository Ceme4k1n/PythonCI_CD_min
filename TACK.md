# Техническое Задание (ТЗ)

## Система CI/CD на Python с интерфейсом Telegram-бота

### 1. Введение

Данное техническое задание описывает разработку системы непрерывной интеграции и развертывания (CI/CD) на Python, предназначенной для управления проектами Python посредством интерфейса Telegram-бота. Система должна быть минималистичной, автономной, работать в контейнере Docker и обеспечивать управление несколькими проектами с возможностью конфигурации, мониторинга и автоматического развертывания.

### 2. Цель системы

Создать систему CI/CD, позволяющую автоматически отслеживать изменения в репозиториях проектов на GitHub, выполнять тестовые и боевые развертывания, а также управлять проектами через удобный интерфейс Telegram-бота.

### 3. Функциональные Требования

#### 3.1. Общие Требования

1. **Язык разработки**: Python.
2. **Контейнеризация**: Система должна работать внутри Docker-контейнера.
3. **Совместимость**: Автоматическое определение операционной системы (Windows или ARM Linux) и корректная настройка путей.
4. **Интерфейс**: Управление проектами через меню Telegram-бота.
5. **Администрирование**: Возможность задания администратора системы посредством номера чата Telegram.

#### 3.2. Управление Проектами через Telegram-бота

1. **Добавление Проектов**:
   - Возможность добавления неограниченного количества проектов.
   - Для каждого проекта необходимо задать:
     - **Имя репозитория**.
     - **Путь к папке проекта** (место, откуда стартовать проект).
     - **Ссылка на GitHub-репозиторий**.

2. **Настройка Конфигурации Проекта**:
   - Для каждого проекта необходимо задать набор конфигурационных переменных:
     - **Название переменной**.
     - **Значение переменной**.
   - **Конфигурационные переменные для тестового запуска**:
     - **Название переменной**.
     - **Значение переменной**.
   - Включает возможность настройки таких параметров, как `API_KEY` и настройки `proxy`, если это необходимо.

3. **Настройка Периода Мониторинга Коммитов**:
   - Задавать интервал (период) для отслеживания новых коммитов в каждом проекте.
   - Настройка проверки должна осуществляться посредством кнопок в меню Telegram-бота.

4. **Запуск Проекта**:
   - Возможность запуска тестового варианта проекта.
   - Индикация состояния выполнения теста.
   - Возможность задания времени для тестирования.
   - Выбор действий после тестирования:
     - Развернуть в базовом месте.
     - Откатить тестовое развертывание.

5. **Управление Версионностью**:
   - Присвоение порядковых номеров коммитам для упрощенного отката.
   - Возможность отката к любому коммиту по его номеру.

6. **Откат Проекта**:
   - Загрузка выбранного коммита.
   - Удаление всех файлов и папок в целевой директории проекта.
   - Перемещение загруженного коммита в целевую папку.
   - Запуск проекта после отката.

7. **Запуск Сторонних Репозиториев**:
   - Возможность запуска сторонних репозиториев внутри контейнера.
   - Определение режима запуска (тестовый или боевой).
   - Выдача результатов выполнения команд в чат Telegram:
     - Ограничение вывода до 30 строк на каждую команду.
     - Возможность выбора включения или отключения этого функционала.
   - Использование библиотеки `telebot` (Telegram Bot API) для реализации функционала запуска.

8. **Запрос Состояния Проекта**:
   - Возможность проверки и отображения текущего состояния проекта (запущен или нет).

9. **Запрос Нагрузки на Систему Docker Контейнера**:
   - Добавление кнопки в интерфейсе Telegram-бота для запроса текущей нагрузки на систему Docker-контейнера.

#### 3.3. Процесс Развертывания

1. **Очистка Целевой Папки**:
   - Команда для удаления всех файлов и подпапок в целевой директории проекта.

2. **Создание Виртуального Окружения**:
   - Создание виртуального окружения `venv` в папке проекта с использованием командной строки.

3. **Загрузка Коммита**:
   - Скачивание выбранного коммита из репозитория.

4. **Обновление и Установка Зависимостей**:
   - Обновление pip до последней версии.
   - Установка пакетов из файла `requirements.txt`.

5. **Запуск Приложения**:
   - Запуск файла `main.py` в отдельном потоке с использованием командной строки.

6. **Регулярная Проверка Коммитов**:
   - Настройка регулярности (по заданному периоду) проверки наличия новых коммитов для каждого проекта посредством кнопок в меню Telegram-бота.

#### 3.4. Обработка Ошибок

- **Неустранимость Сбоев**:
  - Все ошибки должны быть обработаны таким образом, чтобы система никогда не останавливалась.
  - Реализация механизмов перехвата исключений на всех уровнях системы.
  - Логирование всех ошибок и уведомление администратора через Telegram-беседу.
  - Автоматическое восстановление системы после возникновения ошибок.

### 4. Нефункциональные Требования

1. **Безопасность**:
   - Обеспечение безопасного хранения конфигурационных переменных, включая `API_KEY`.
   - Ограничение доступа к системе посредством авторизации в Telegram-боте.
   - Задание администратора системы посредством номера чата Telegram.

2. **Производительность**:
   - Обеспечение быстрого отклика интерфейса Telegram-бота.
   - Эффективное использование ресурсов при работе внутри Docker-контейнера.

3. **Надежность**:
   - Обеспечение надежной работы системы при различных условиях эксплуатации.
   - Автоматическое восстановление после сбоев.
   - Обязательная обработка всех ошибок для предотвращения остановки системы.

4. **Юзабилити**:
   - Интуитивно понятный интерфейс Telegram-бота.
   - Простота добавления и управления проектами.

### 5. Технические Требования

1. **Язык программирования**: Python (версия по согласованию).
2. **Библиотеки и Фреймворки**:
   - `python-telegram-bot` и `telebot` для реализации Telegram-бота.
   - `GitPython` или аналогичные для работы с Git-репозиториями.
   - `docker` SDK для взаимодействия с Docker-контейнерами.
3. **Контейнеризация**:
   - Использование Docker для изоляции среды выполнения.
   - Автоматическая настройка путей в зависимости от операционной системы (Windows или ARM Linux).
4. **Хранение Данных**:
   - Использование локальной базы данных (например, SQLite) или конфигурационных файлов для хранения настроек проектов и конфигурационных переменных.

### 6. Архитектура Системы

1. **Компоненты**:
   - **Telegram-бот**: Интерфейс для взаимодействия с пользователем.
   - **Модуль управления проектами**: Обработка добавления, настройки и удаления проектов.
   - **Модуль мониторинга Git**: Отслеживание новых коммитов согласно заданному периоду.
   - **Модуль развертывания**: Выполнение шагов развертывания и отката.
   - **Модуль состояния**: Отслеживание и отображение текущего состояния проектов.
   - **Модуль мониторинга Докеr Контейнера**: Отслеживание нагрузки на систему Docker-контейнера.
   - **Обработчик Ошибок**: Гарантия непрерывной работы системы путем обработки всех исключений.
   - **Контейнер Docker**: Среда выполнения всей системы.

2. **Взаимодействие Компонентов**:
   - Пользователь взаимодействует с системой через Telegram-бота.
   - Бот передает команды в соответствующие модули системы.
   - Модули взаимодействуют с GitHub для получения коммитов и управления репозиториями.
   - Модуль развертывания выполняет операции внутри Docker-контейнера.
   - Модуль мониторинга Docker-контейнера собирает информацию о нагрузке и предоставляет её по запросу.
   - Обработчик ошибок перехватывает и обрабатывает все возникающие исключения, предотвращая остановку системы.
   - Система обеспечивает логирование и отчеты через чат Telegram.

### 7. Пользовательский Интерфейс

1. **Основное Меню Бота**:
   - **Добавить Проект**: Формы для ввода имени репозитория, пути к проекту, ссылки на GitHub.
   - **Настроить Конфигурацию**: Интерфейс для добавления и редактирования переменных окружения, включая отдельные переменные для тестового запуска.
   - **Настроить Период Мониторинга**: Выбор интервала проверки коммитов посредством кнопок в меню.
   - **Запустить Проект**: Кнопки для запуска тестовых и боевых версий.
   - **Откатить Проект**: Выбор коммита для отката.
   - **Запросить Состояние**: Проверка текущего состояния проекта.
   - **Запустить Сторонний Репозиторий**: Опции запуска сторонних репозиториев.
   - **Запросить Нагрузку на Систему**: Кнопка для получения информации о текущей нагрузке на Docker-контейнер.

2. **Взаимодействие**:
   - Использование кнопок и меню для навигации.
   - Отображение результатов выполнения команд в виде сообщений с ограничением до 30 строк на команду.
   - Реализация через `python-telegram-bot` и `telebot` для обеспечения функциональности Telegram-бота.

### 8. Процесс Развертывания и Операции

#### 8.1. Запуск Проекта

1. **Выбор Проекта**:
   - Пользователь выбирает проект из списка доступных через меню бота.

2. **Тестовый Запуск**:
   - Система выполняет развертывание проекта с текущими настройками, включая отдельные конфигурационные переменные для тестового запуска.
   - Индикация состояния выполнения теста.
   - Задание времени для тестирования (настраивается пользователем).
   - После тестирования пользователь выбирает:
     - Развернуть в базовом месте (боевой запуск).
     - Откатить тестовое развертывание.

3. **Боевой Запуск**:
   - При подтверждении развертывания, система обновляет боевую среду проекта.

4. **Управление Версионностью**:
   - Присвоение порядкового номера каждому коммиту при развертывании.
   - Хранение истории версий для возможности отката.

#### 8.2. Откат Проекта

1. **Выбор Коммита для Отката**:
   - Пользователь выбирает нужный коммит по его порядковому номеру через интерфейс бота.

2. **Процесс Отката**:
   - Система скачивает выбранный коммит из GitHub.
   - Удаляет все файлы и папки в целевой директории проекта.
   - Перемещает скачанный коммит в целевую папку.
   - Запускает проект после успешного отката.

#### 8.3. Развертывание Стороннего Репозитория

1. **Добавление Репозитория**:
   - Пользователь может добавить сторонний репозиторий для развертывания через интерфейс бота.

2. **Настройка и Запуск**:
   - Настройка конфигурационных переменных и периодов мониторинга.
   - Выбор режима запуска (тестовый или боевой).
   - Отображение результатов выполнения команд в чат с ограничением до 30 строк на команду.

#### 8.4. Виртуальное Окружение и Установка Зависимостей

1. **Создание Виртуального Окружения**:
   - Использование командной строки для создания `venv` в папке проекта.

2. **Обновление pip и Установка Пакетов**:
   - Обновление pip до последней версии.
   - Установка необходимых пакетов из `requirements.txt`.

3. **Запуск Приложения**:
   - Запуск `main.py` в отдельном потоке с использованием командной строки.

4. **Запрос Нагрузки на Систему Docker Контейнера**:
   - Реализация кнопки в Telegram-боте для запроса текущей нагрузки на Docker-контейнер.
   - Отображение информации о загрузке CPU, памяти и других ресурсов контейнера.

### 9. Требования к Документации

1. **Пользовательская Документация**:
   - Инструкция по установке и настройке системы.
   - Руководство по использованию Telegram-бота для управления проектами.
   - Описание всех доступных команд и функций.
   - Инструкция по настройке администратора системы.

2. **Техническая Документация**:
   - Детальное описание архитектуры системы.
   - Описание интеграций с внешними сервисами (GitHub, Telegram).
   - Руководство по развертыванию системы в Docker-контейнере.
   - Описание механизмов обработки ошибок и обеспечения непрерывной работы системы.

### 10. Тестирование

1. **Функциональное Тестирование**:
   - Проверка всех функций Telegram-бота.
   - Тестирование добавления, настройки и удаления проектов.
   - Проверка корректности мониторинга коммитов и развертывания.
   - Тестирование отдельных конфигураций для тестового и боевого запусков.

2. **Нагрузочное Тестирование**:
   - Оценка производительности системы при управлении большим количеством проектов.
   - Тестирование реакции системы на одновременные запросы через Telegram-бота.

3. **Тестирование Безопасности**:
   - Проверка защиты конфиденциальных данных.
   - Тестирование механизмов авторизации и аутентификации.
   - Проверка безопасности взаимодействия Telegram-бота с системой.

4. **Тестирование Совместимости**:
   - Проверка работы системы на различных операционных системах (Windows, ARM Linux).
   - Тестирование работы системы внутри Docker-контейнера на разных хостовых платформах.

5. **Тестирование Обработки Ошибок**:
   - Проверка устойчивости системы при возникновении различных ошибок.
   - Убедиться, что система продолжает работу после обработки исключений без остановки.

### 11. Заключение

Данное техническое задание описывает создание эффективной и гибкой системы CI/CD на Python с интерфейсом Telegram-бота. Система должна обеспечивать автоматизацию процессов развертывания, управления версиями и мониторинга проектов, при этом быть простой в использовании и надежной в эксплуатации. Реализация всех функциональных и нефункциональных требований, включая расширенные возможности конфигурации, мониторинга нагрузки на Docker-контейнер и обязательной обработки всех ошибок, позволит создать инструмент, оптимизирующий процессы разработки и деплоя для проектов на Python.